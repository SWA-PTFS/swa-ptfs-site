<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SWA PTFS Admin Panel</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h2 { margin-top: 30px; }
  input, select, button { margin: 5px; padding: 5px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f4f4f4; }
  .hidden { display: none; }
</style>
</head>
<body>

<h1>Admin Panel</h1>

<!-- LOGIN -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<!-- ADMIN PANEL -->
<div id="adminDiv" class="hidden">
  <h2>Create Flight</h2>
  <input type="text" id="flightNumber" placeholder="Flight Number">
  <input type="text" id="origin" placeholder="Origin">
  <input type="text" id="destination" placeholder="Destination">
  <input type="datetime-local" id="time">
  <select id="status">
    <option value="Scheduled">Scheduled</option>
    <option value="Delayed">Delayed</option>
    <option value="Cancelled">Cancelled</option>
    <option value="Completed">Completed</option>
  </select>
  <button onclick="createFlight()">Create Flight</button>

  <h2>Flight List</h2>
  <table id="flightsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Flight Number</th>
        <th>Origin</th>
        <th>Destination</th>
        <th>Time</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let token = '';

async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  try {
    const res = await fetch('https://swaptfs.sfleishman.workers.dev/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) throw new Error('Login failed');

    const data = await res.json();
    token = data.token;

    document.getElementById('loginDiv').classList.add('hidden');
    document.getElementById('adminDiv').classList.remove('hidden');

    fetchFlights();
  } catch (err) {
    document.getElementById('loginMsg').innerText = 'Invalid credentials';
  }
}

async function fetchFlights() {
  const res = await fetch('https://swaptfs.sfleishman.workers.dev/flights', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const flights = await res.json();
  const tbody = document.querySelector('#flightsTable tbody');
  tbody.innerHTML = '';

  flights.forEach(f => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${f.id}</td>
      <td>${f.flightNumber}</td>
      <td>${f.origin}</td>
      <td>${f.destination}</td>
      <td>${new Date(f.time).toLocaleString()}</td>
      <td>
        <select data-id="${f.id}">
          <option ${f.status==='Scheduled'?'selected':''}>Scheduled</option>
          <option ${f.status==='Delayed'?'selected':''}>Delayed</option>
          <option ${f.status==='Cancelled'?'selected':''}>Cancelled</option>
          <option ${f.status==='Completed'?'selected':''}>Completed</option>
        </select>
      </td>
      <td><button onclick="updateFlight(${f.id})">Update</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function createFlight() {
  const flight = {
    flightNumber: document.getElementById('flightNumber').value,
    origin: document.getElementById('origin').value,
    destination: document.getElementById('destination').value,
    time: document.getElementById('time').value,
    status: document.getElementById('status').value
  };

  await fetch('https://swaptfs.sfleishman.workers.dev/flights', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(flight)
  });

  fetchFlights();
}

async function updateFlight(id) {
  const select = document.querySelector(`select[data-id="${id}"]`);
  const status = select.value;

  await fetch(`https://swaptfs.sfleishman.workers.dev/flights/${id}`, {
    method: 'PUT',
    headers: { 
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ status })
  });

  fetchFlights();
}
</script>

</body>
</html>
